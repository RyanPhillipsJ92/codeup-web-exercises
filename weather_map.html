<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


    <!--****MAP BOX*****-->
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css' rel='stylesheet' />
    <!--****MAP BOX*****-->
    <!-- Custom CSS -->
    <title>My weather map</title>
</head>
<body>

<h1>Weather Map Project</h1>

<div id="userCity">
    <label>
        <input id="userInput" placeholder="Enter city">
    </label>
</div>
<!--******MAP DIV*******-->
<div id='map' style='width: 800px; height:  400px;'></div>
<div id="5dayContainer">
<!--    *****     CARD TEMPLATE**** -->
    <div class="card" style="width: 18rem;">
        <img src="..." class="card-img-top" alt="...">
        <div class="card-body">
            <h6 class="card-title">Day: </h6>
            <h6 class="card-title">Temperature: </h6>
            <h6 class="card-title">Description: </h6>
            <h6 class="card-title">Humidity: </h6>
            <h6 class="card-title">Winds:</h6>
            <h6 class="card-title">Pressure:</h6>
        </div>
    </div>
</div>

<h5>Tips</h5>
<ul>
    <li>Day</li>
    <li>Temperature</li>
    <li>Description:</li>
    <li>Humidity:</li>
    <li>Winds:</li>
    <li>Pressure:</li>
    <li>To add mapbox autocomplete search, you will need to include geocoder scripts from mapbox</li>
</ul>

<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>


<script src="js/keys.js"></script>

<script>
    $(document).ready(function () {

        "use strict";
        //****Global variables for users geolocation
        var userLatitude;
        var userLongitude;
        var userMarker = new mapboxgl.Marker({
            draggable:true
        });
//*****Function to get and store users location and open map via coordinates as well as place marker at location
        function getLocation () {
            if ("geolocation" in navigator){ //check geolocation available
                //try to get user current location using getCurrentPosition() method
                navigator.geolocation.getCurrentPosition(function(position){
                userLatitude = position.coords.latitude;
                userLongitude = position.coords.longitude
                    getWeather(userLongitude, userLatitude);
                    map.setCenter([userLongitude, userLatitude])
                    userMarker.setLngLat([userLongitude, userLatitude])
                    userMarker.addTo(map);
                })
            }else{
                alert("Browser doesn't support geolocation!");
                getWeather(77.0365 ,38.8977 );
                map.setCenter([77.0365, 38.8977]);
            }
        }
        getLocation();
        function getWeather(long, lat){
            $.get("https://api.openweathermap.org/data/2.5/onecall", {
                APPID: OPEN_WEATHER_APPID,
                lat: lat,
                lon: long,
                units: "imperial",
                exclude: "minutely,hourly,alerts"
            }).done(function (data) {
                console.log(data);
            });
        }

        //**** Draggable marker Getting long and lat
        function onDragEnd() {
            var lngLat = userMarker.getLngLat();
            userLatitude = lngLat.lat;
            userLongitude = lngLat.lng
            console.log(userLatitude)
            console.log(userLongitude)
            getWeather(userLongitude, userLatitude);
            map.setCenter([userLongitude, userLatitude]);
                userMarker.setLngLat([userLongitude, userLatitude])
        }
        userMarker.on('dragend', onDragEnd);


        // **** MAP*******
        mapboxgl.accessToken =mapboxToken;
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11', // stylesheet location
            zoom: 9// starting zoom
        });
        map.doubleClickZoom.disable();
        //   ******End Map *****


        //*** GEO CODE FUNCTION ***//
        function geocode(search, token) {
            var baseUrl = 'https://api.mapbox.com';
            var endPoint = '/geocoding/v5/mapbox.places/';
            return fetch(baseUrl + endPoint + encodeURIComponent(search) + '.json' + "?" + 'access_token=' + token)
                .then(function(res) {
                    return res.json();
                }).then(function(data) {
                    return data.features[0].center;
                });
        }
        // ****** INPUT BOX PASSING GEOLOCATION VIA SEARCH ********
        $('#userInput').change(function(event){
            console.log($('#userInput').val());
            var userEntry = geocode($('#userInput').val(), mapboxToken).then(function(results) {
                map.setCenter(results);
                userMarker.setLngLat(map.getCenter());
                });
        });

            map.on('dblclick', function(e){
                userLatitude = [e.lngLat.lat];
                userLongitude = [e.lngLat.lng];
                    console.log('howdy')
                    map.setCenter([userLongitude, userLatitude]);
                    userMarker.setLngLat([userLongitude, userLatitude])
                getWeather(userLongitude, userLatitude);
            });

        // function dblClick(results) {
        //     console.log('howdy')
        //     map.setCenter([userLongitude, userLatitude]);
        //
        //         console.log(userLatitude)
        //         console.log(userLongitude)
        //         getWeather(userLongitude, userLatitude);
        //         // map.setCenter([userLongitude, userLatitude]);
        //     };
        //
        // map.on('dblclick', function(e){
        //     dblClick();
        //
        //
        // });
        // dblClick();
    });



</script>
</body>
</html>